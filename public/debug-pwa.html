<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PWA Debug - EveryTodo</title>
    <link rel="manifest" href="/manifest.json">
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 900px;
            margin: 0 auto;
            padding: 20px;
            line-height: 1.6;
            background: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .status {
            padding: 15px;
            margin: 15px 0;
            border-radius: 8px;
            border-left: 4px solid;
        }
        .success { 
            background-color: #d4edda; 
            color: #155724; 
            border-left-color: #28a745;
        }
        .error { 
            background-color: #f8d7da; 
            color: #721c24; 
            border-left-color: #dc3545;
        }
        .warning { 
            background-color: #fff3cd; 
            color: #856404; 
            border-left-color: #ffc107;
        }
        .info { 
            background-color: #d1ecf1; 
            color: #0c5460; 
            border-left-color: #17a2b8;
        }
        button {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            margin: 8px;
            font-size: 16px;
            transition: background-color 0.2s;
        }
        button:hover { background-color: #0056b3; }
        button:disabled { 
            background-color: #6c757d; 
            cursor: not-allowed; 
        }
        .hidden { display: none; }
        .debug-section {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            margin: 20px 0;
        }
        .icon-test {
            display: flex;
            gap: 15px;
            margin: 15px 0;
            flex-wrap: wrap;
        }
        .icon-test img {
            border: 2px solid #ddd;
            border-radius: 8px;
            padding: 5px;
        }
        .step {
            background: #e9ecef;
            padding: 15px;
            margin: 10px 0;
            border-radius: 6px;
            border-left: 4px solid #007bff;
        }
        .code {
            background: #f8f9fa;
            padding: 10px;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            margin: 10px 0;
            border: 1px solid #e9ecef;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîß PWA Installation Debug Tool</h1>
        <p>This tool will help diagnose why PWA installation might not be working on your tablet.</p>
        
        <div id="status-container">
            <h2>üìä Installation Status</h2>
            <div id="status-messages"></div>
        </div>
        
        <div id="install-section" class="hidden">
            <h2>üì± Install App</h2>
            <button id="install-btn">Install EveryTodo App</button>
            <p><small>If the button doesn't work, try the manual installation steps below.</small></p>
        </div>
        
        <div class="debug-section">
            <h2>üîç Technical Requirements Check</h2>
            <div id="requirements-check"></div>
        </div>
        
        <div class="debug-section">
            <h2>üñºÔ∏è Icon Test</h2>
            <p>Testing if all required icons are loading correctly:</p>
            <div class="icon-test">
                <div>
                    <img src="/icon-144.png" alt="144x144" width="72" height="72">
                    <br><small>144x144</small>
                </div>
                <div>
                    <img src="/icon-192.png" alt="192x192" width="96" height="96">
                    <br><small>192x192</small>
                </div>
                <div>
                    <img src="/icon-384.png" alt="384x384" width="96" height="96">
                    <br><small>384x384</small>
                </div>
                <div>
                    <img src="/icon-512.png" alt="512x512" width="96" height="96">
                    <br><small>512x512</small>
                </div>
            </div>
        </div>
        
        <div class="debug-section">
            <h2>üìã Manual Installation Steps</h2>
            <div class="step">
                <h3>For Android Tablets (Chrome/Edge):</h3>
                <ol>
                    <li>Look for the <strong>install icon</strong> in the address bar (looks like a download arrow or plus sign)</li>
                    <li>If you don't see it, tap the <strong>three dots menu</strong> (‚ãÆ) in the top right</li>
                    <li>Look for <strong>"Install app"</strong> or <strong>"Add to Home screen"</strong></li>
                    <li>Tap it and follow the prompts</li>
                </ol>
            </div>
            
            <div class="step">
                <h3>For iPad (Safari):</h3>
                <ol>
                    <li>Tap the <strong>Share button</strong> (square with arrow up) at the bottom</li>
                    <li>Scroll down and tap <strong>"Add to Home Screen"</strong></li>
                    <li>Tap <strong>"Add"</strong> to confirm</li>
                </ol>
            </div>
            
            <div class="step">
                <h3>If Installation Still Doesn't Work:</h3>
                <ol>
                    <li>Make sure you're using <strong>HTTPS</strong> (not HTTP)</li>
                    <li>Clear your browser cache and cookies</li>
                    <li>Try a different browser (Chrome, Edge, Safari)</li>
                    <li>Restart your browser completely</li>
                    <li>Check if your tablet's browser is up to date</li>
                </ol>
            </div>
        </div>
        
        <div class="debug-section">
            <h2>üêõ Debug Information</h2>
            <div id="debug-content"></div>
        </div>
    </div>

    <script>
        let deferredPrompt;
        const statusContainer = document.getElementById('status-messages');
        const installSection = document.getElementById('install-section');
        const installBtn = document.getElementById('install-btn');
        const debugContent = document.getElementById('debug-content');
        const requirementsCheck = document.getElementById('requirements-check');

        function addStatus(message, type = 'info') {
            const div = document.createElement('div');
            div.className = `status ${type}`;
            div.textContent = message;
            statusContainer.appendChild(div);
        }

        function addRequirement(requirement, status, details = '') {
            const div = document.createElement('div');
            div.className = `status ${status}`;
            div.innerHTML = `<strong>${requirement}:</strong> ${details}`;
            requirementsCheck.appendChild(div);
        }

        function addDebugInfo(label, value) {
            const div = document.createElement('div');
            div.innerHTML = `<strong>${label}:</strong> <span class="code">${value}</span>`;
            debugContent.appendChild(div);
        }

        // Check PWA requirements
        function checkPWARequirements() {
            // Basic requirements
            addRequirement('HTTPS Protocol', 
                window.location.protocol === 'https:' ? 'success' : 'error',
                window.location.protocol === 'https:' ? '‚úÖ Secure connection' : '‚ùå HTTP not allowed for PWA installation'
            );
            
            addRequirement('Service Worker Support', 
                'serviceWorker' in navigator ? 'success' : 'error',
                'serviceWorker' in navigator ? '‚úÖ Supported' : '‚ùå Not supported'
            );
            
            addRequirement('Display Mode', 
                window.matchMedia('(display-mode: standalone)').matches ? 'success' : 'info',
                window.matchMedia('(display-mode: standalone)').matches ? '‚úÖ Already installed' : '‚ÑπÔ∏è Running in browser'
            );
            
            // Check manifest
            fetch('/manifest.json')
                .then(response => {
                    if (!response.ok) {
                        addRequirement('Manifest File', 'error', '‚ùå Cannot load manifest.json');
                        return;
                    }
                    return response.json();
                })
                .then(manifest => {
                    if (manifest) {
                        addRequirement('Manifest File', 'success', '‚úÖ Loaded successfully');
                        addRequirement('App Name', 'success', `‚úÖ ${manifest.name}`);
                        addRequirement('Icons', 
                            manifest.icons && manifest.icons.length >= 2 ? 'success' : 'error',
                            manifest.icons ? `‚úÖ ${manifest.icons.length} icons found` : '‚ùå No icons found'
                        );
                        addRequirement('Display Mode', 'success', `‚úÖ ${manifest.display}`);
                        addRequirement('Start URL', 'success', `‚úÖ ${manifest.start_url}`);
                    }
                })
                .catch(error => {
                    addRequirement('Manifest File', 'error', `‚ùå Error: ${error.message}`);
                });
        }

        // Check service worker
        function checkServiceWorker() {
            if ('serviceWorker' in navigator) {
                navigator.serviceWorker.getRegistration()
                    .then(registration => {
                        if (registration) {
                            addRequirement('Service Worker', 'success', '‚úÖ Registered and active');
                            addDebugInfo('SW State', registration.active ? registration.active.state : 'No active worker');
                            addDebugInfo('SW Scope', registration.scope);
                        } else {
                            addRequirement('Service Worker', 'error', '‚ùå Not registered');
                        }
                    })
                    .catch(error => {
                        addRequirement('Service Worker', 'error', `‚ùå Error: ${error.message}`);
                    });
            }
        }

        // Install button handler
        installBtn.addEventListener('click', async () => {
            if (deferredPrompt) {
                try {
                    deferredPrompt.prompt();
                    const { outcome } = await deferredPrompt.userChoice;
                    addStatus(`Install prompt outcome: ${outcome}`, outcome === 'accepted' ? 'success' : 'warning');
                    deferredPrompt = null;
                    installSection.classList.add('hidden');
                } catch (error) {
                    addStatus(`Install error: ${error.message}`, 'error');
                }
            } else {
                addStatus('Install prompt not available. Try manual installation steps above.', 'warning');
            }
        });

        // Listen for beforeinstallprompt event
        window.addEventListener('beforeinstallprompt', (e) => {
            addStatus('üéâ Install prompt is available! Click the install button above.', 'success');
            e.preventDefault();
            deferredPrompt = e;
            installSection.classList.remove('hidden');
        });

        // Listen for appinstalled event
        window.addEventListener('appinstalled', () => {
            addStatus('üéâ App was installed successfully!', 'success');
            installSection.classList.add('hidden');
        });

        // Check if already installed
        if (window.matchMedia('(display-mode: standalone)').matches) {
            addStatus('‚úÖ App is already installed and running in standalone mode', 'success');
        }

        // Add debug information
        addDebugInfo('User Agent', navigator.userAgent);
        addDebugInfo('Protocol', window.location.protocol);
        addDebugInfo('Host', window.location.host);
        addDebugInfo('Path', window.location.pathname);
        addDebugInfo('Screen Size', `${screen.width}x${screen.height}`);
        addDebugInfo('Viewport Size', `${window.innerWidth}x${window.innerHeight}`);
        addDebugInfo('Device Pixel Ratio', window.devicePixelRatio);
        addDebugInfo('Touch Support', 'ontouchstart' in window ? 'Yes' : 'No');
        addDebugInfo('Online Status', navigator.onLine ? 'Online' : 'Offline');

        // Initialize checks
        checkPWARequirements();
        checkServiceWorker();
        
        // Add interaction requirement
        addStatus('üí° Tip: Interact with the page (click, scroll, tap) to meet Chrome\'s engagement requirements for installation.', 'info');
    </script>
</body>
</html>
